services:
  backend:
    build:
      context: ./3DBackend
      dockerfile: Dockerfile
    container_name: web3d-backend
    expose:
      - "5000"
    environment:
      - NODE_ENV=production
    env_file:
      - ./3DBackend/.env
    restart: unless-stopped
    networks:
      - web3d-network
    depends_on:
      - mongodb

  frontend:
    build:
      context: ./3DFE
      dockerfile: Dockerfile
    container_name: web3d-frontend
    expose:
      - "3000"
    environment:
      - NODE_ENV=production
    env_file:
      - ./3DFE/.env
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - web3d-network

  dashboard:
    build:
      context: ./Dashboard/dashboard
      dockerfile: Dockerfile
    container_name: web3d-dashboard
    expose:
      - "4000"
    environment:
      - NODE_ENV=production
    env_file:
      - ./Dashboard/dashboard/.env
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - web3d-network

  clip-service:
    build:
      context: ./clip_service_recovered
      dockerfile: Dockerfile
    container_name: web3d-clip-service
    expose:
      - "5001"
    environment:
      - FLASK_ENV=production
    restart: unless-stopped
    networks:
      - web3d-network
    volumes:
      - ./clip_service_recovered/faiss_index_3d_products_clip.idx:/app/faiss_index_3d_products_clip.idx
      - ./clip_service_recovered/product_paths_clip.npy:/app/product_paths_clip.npy
      - ./clip_service_recovered/product_metadata.json:/app/product_metadata.json

  mongodb:
    image: mongo:latest
    container_name: web3d-mongodb
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=mongo_user
      - MONGO_INITDB_ROOT_PASSWORD=mongo_password
      - MONGO_INITDB_DATABASE=web3d
    command: [--auth, --bind_ip_all]
    volumes:
      - mongodb_data:/data/db
    networks:
      - web3d-network
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    container_name: web3d-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/conf:/etc/nginx/conf.d
      - ./nginx/maintenance.html:/usr/share/nginx/html/maintenance.html
    environment:
      - NGINX_HOST=3dvn.org
      - NGINX_PORT=80
    depends_on:
      - frontend
      - backend
      - dashboard
    networks:
      - web3d-network
    restart: unless-stopped

volumes:
  mongodb_data:

networks:
  web3d-network:
    driver: bridge
